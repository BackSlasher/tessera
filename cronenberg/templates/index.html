<!-- -*- mode:jinja2 -*- -->
{% extends "layouts/standard.html" %}
{% from "presentations.html" import singlestat with context %}

{% block pagetitle %}
  <span class="primary-title">{{app}}</span> <span class="secondary-title">{{title}}</span>
{% endblock %}

{% block layout %}

  <script>
    <!-- Set up the query registry -->
    {% for name,url in queries.iteritems() -%}
      cronenberg.add_query('{{name}}', '{{url|safe}}');
    {%- endfor %}
  </script>


  <div class="row-fluid text-right">
    {% include "snippets/recent-range-picker.html" %}
  </div>

  <!-- ============================================================================= -->
  <!-- Funnel summary row -->
  <!-- ============================================================================= -->

  <div class="row-fluid">

    {{ singlestat(pres_raw_events) }}
    {{ singlestat(pres_triggers_processed) }}
    {{ singlestat(pres_triggers_satisfied) }}
    {{ singlestat(pres_pushes_sent) }}

  </div> <!-- row -->
  <hr/>

  <!-- ============================================================================= -->
  <!-- Pushes -->
  <!-- ============================================================================= -->

  <div class="row graphline">
    {{ singlestat(mean_push_rate) }}
    <div class="span8">
      <div class="graph" id="g1">
        <svg></svg>
      </div>
    </div>
  </div>
    <script>
      bean.on(cronenberg.queries.total_push_rate, 'data-available', function(query) {
          makeChart($("#g1"), query.data[0]);
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Delivery -->
  <!-- ============================================================================= -->

  <div class="row graphline">
    <div class="span2 offset2">
      <div class="singlestat">
        <h3>Mean End to End<br/>Delivery Time</h3>
        <p><span id="s6"></span><span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g2">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.end_to_end, 'data-available', function(query) {
          $("#s6").text(query.data[0].summation.mean.toFixed(2));
          makeChart($("#g2"), query.data[0]);
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Immediate Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Processed</h3>
        <p><span id="s7"></span><span class="unit">/sec</span></p>
      </div>
    </div>

    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Satisfied</h3>
        <p><span id="s8"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g3">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.immediate_triggers, 'data-available', function(query) {
          $("#s7").text(query.data[0].summation.mean.toFixed(2));
          makeChart($("#g3"), query.data[0]);
          $("#s8").text(query.data[3].summation.mean.toFixed(2));
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Historical Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Processed</h3>
        <p><span id="s9"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Satisfied</h3>
        <p><span id="s10"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g4">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.historical_triggers, 'data-available', function(query) {
          $("#s9").text(query.data[0].summation.mean.toFixed(2));
          makeChart($("#g4"), query.data[0]);
          $("#s10").text(query.data[3].summation.mean.toFixed(2));
      });
    </script>


  <!-- ============================================================================= -->
  <!-- API -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Mean API Response Time</h3>
        <p><span id="s11"></span><span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>API Requests</h3>
        <p id="s12"></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g5">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.api_latency, 'data-available', function(query) {
          $("#s11").text(query.data[0].summation.mean.toFixed(2));
      });
      bean.on(cronenberg.queries.api_rate, 'data-available', function(query) {
          makeChart($("#g5"), query.data[0]);
          $("#s12").text(query.data[1].summation.sum);
      });
    </script>

  <!-- ============================================================================= -->
  <!-- Device Opens -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Device Opens Rate</h3>
        <p><span id="s13"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g6">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.device_event_rate, 'data-available', function(query) {
      $("#s13").text(query.data[0].summation.mean.toFixed(0));
      makeChart($("#g6"), query.data[0]);
      });
    </script>


  <p>&nbsp;</p>

  <script>
    <!-- launch the queries -->

    function makeChart(e, series) {
        // would rather not transform the whole array here, but I
        // can't get the x/y functions working properly
        var data = [{
            values: series.datapoints,
            key: series.target
        }];
        nv.addGraph(function() {
            var width = e.width();
            var height = e.height();
            var chart = nv.models.lineChart()
                .options({
                    showXAxis: false,
                    showYAxis: false,
                    showLegend: false,
                    useInteractiveGuideline: true,
                    x: function(d) { return d[1]; },
                    y: function(d) { return d[0]; }
                })
                .width(width)
                .height(height)
                .margin({ top: 0, right: 0, bottom: 0, left: 0 });
            chart.yAxis.tickFormat(d3.format(',.2f'));
            chart.xAxis.tickFormat(function(d) { return moment.unix(d).fromNow(); });
            d3.select(e.selector + ' svg')
                .attr('width', width)
                .attr('height', height)
                .datum(data)
                .call(chart);
            return chart;
        });
    }

   cronenberg.load_queries();

  </script>

{% endblock %}

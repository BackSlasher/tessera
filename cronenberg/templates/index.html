<!-- -*- mode:jinja2 -*- -->
{% extends "layouts/standard.html" %}
{% from "charts/flot.js" import render_chart with context %}

{% block pagetitle %}
  <span class="primary-title">{{app}}</span> <span class="secondary-title">{{title}}</span>
{% endblock %}


{% block layout %}

  <script>
    <!-- Set up the query registry -->
    window.cronenberg = {};
    window.cronenberg.queries = {};
    {% for name,query in queries.iteritems() -%}
      window.cronenberg.queries.{{name}} = {
          name: '{{name}}',
          data: [],
          presentations: [],
          url: '{{ query }}'
      };
    {%- endfor %}
  </script>


  <div class="row-fluid text-right">
    {% include "snippets/recent-range-picker.html" %}
  </div>

  <!-- ============================================================================= -->
  <!-- Funnel summary row -->
  <!-- ============================================================================= -->

  <div class="row-fluid">

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Raw Events Processed</h3>
          <p>{{ context['total-events-processed'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Processed</h3>
          <p>{{ context['triggers-processed'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Satisfied</h3>
          <p>{{ context['triggers-satisfied'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Pushes Sent</h3>
          <p>{{ context['pushes-sent'] }}</p>
        </div>
      </div>
    </div>

  </div> <!-- row -->
  <hr/>

  <!-- ============================================================================= -->
  <!-- Pushes -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Push Rate</h3>
        <p>{{ context['average-push-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container"></div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Delivery -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean End to End<br/>Delivery Time</h3>
        <p>{{ context['average-end-to-end']}}<span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container">
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Immediate Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Processed</h3>
        <p>{{ context['immediate-processed-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Satisfied</h3>
        <p>{{ context['immediate-satisfied-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container"></div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Historical Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Processed</h3>
        <p>{{ context['historical-processed-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Satisfied</h3>
        <p>{{ context['historical-satisfied-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container"></div>
      </div>
    </div>
  </div>


  <!-- ============================================================================= -->
  <!-- API -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Mean API Response Time</h3>
        <p>{{ context['api-mean-latency'] }}<span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>API Requests</h3>
        <p>{{ context['api-total'] }}</p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container"></div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Device Opens -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Device Opens Rate</h3>
        <p>{{ context['mean-device-opens-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container"></div>
      </div>
    </div>
  </div>



  <p>&nbsp;</p>

  <script>
    <!-- launch the queries -->
    function makeHandler(query) {
        return function(data) {
            console.log(query.name);
            window.cronenberg.queries[query.name].data = data;
            bean.fire(query, 'data-available');
        };
    }
    for (var query_name in window.cronenberg.queries) {
        var query = window.cronenberg.queries[query_name]
        console.log('Fetching ' + query.url);
        $.getJSON(query.url, makeHandler(query));
    }

/*

    window.charts = {}
        $(".graph-container").map(function(i, e) {
        var chartid = "chart" + i;
        var selector = '#' + chartid;
        var data = JSON.parse(e.getAttribute('datastring'));
        $(e).append('<div class="graph-render" id="' + chartid + '"><svg></svg></div>');
        var chart_element = $(selector);


        nv.addGraph(function() {
            var width = chart_element.width();
            var height = chart_element.height();
            var chart = nv.models.lineChart()
                .options({
                    showXAxis: false,
                    showYAxis: false,
                    showLegend: false,
                    useInteractiveGuideline: true
                })
                .width(width)
                .height(height)
                .margin({ top: 0, right: 0, bottom: 0, left: 0 });
            chart.yAxis.tickFormat(d3.format(',.2f'));
            chart.xAxis.tickFormat(function(d) { return moment.unix(d).fromNow(); });
            window.charts[chartid] = chart;
            d3.select(selector + ' svg')
                .attr('width', width)
                .attr('height', height)
                .datum(data)
                .call(chart);
            return chart;
        });
    });
*/
  </script>

{% endblock %}

<!-- -*- mode:jinja2 -*- -->
{% extends "layouts/standard.html" %}

{% block pagetitle %}
  <span class="primary-title">{{app}}</span> <span class="secondary-title">{{title}}</span>
{% endblock %}

{% block layout %}

  <script>
    <!-- Set up the query registry -->
    cronenberg = cronenberg || {};
    cronenberg.queries = {};
    {% for name,query in queries.iteritems() -%}
      cronenberg.queries.{{name}} = {
          name: '{{name}}',
          data: [],
          presentations: [],
          url: '{{ query }}'
      };
    {%- endfor %}
  </script>


  <div class="row-fluid text-right">
    {% include "snippets/recent-range-picker.html" %}
  </div>

  <!-- ============================================================================= -->
  <!-- Funnel summary row -->
  <!-- ============================================================================= -->

  <div class="row-fluid">

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Raw Events Processed</h3>
          <p id="s1"></p>
        </div>
      </div>
    </div>
    <script>
    bean.on(cronenberg.queries.total_events_processed, 'data-available', function(query) {
        summation = cronenberg.reduce_series(query.data[0]);
        $("#s1").text(summation.sum);
    });
    </script>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Processed</h3>
          <p id="s2"></p>
        </div>
      </div>
    </div>

    <script>
      bean.on(cronenberg.queries.total_triggers_processed, 'data-available', function(query) {
        summation = cronenberg.reduce_series(query.data[0]);
        $("#s2").text(summation.sum);
      });
    </script>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Satisfied</h3>
          <p id="s3"></p>
        </div>
      </div>
    </div>

    <script>
      bean.on(cronenberg.queries.total_triggers_satisfied, 'data-available', function(query) {
        summation = cronenberg.reduce_series(query.data[0]);
        $("#s3").text(summation.sum);
      });
    </script>


    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Pushes Sent</h3>
          <p id="s4"></p>
        </div>
      </div>
    </div>

    <script>
      bean.on(cronenberg.queries.total_pushes_sent, 'data-available', function(query) {
        summation = cronenberg.reduce_series(query.data[0]);
        $("#s4").text(summation.sum);
      });
    </script>


  </div> <!-- row -->
  <hr/>

  <!-- ============================================================================= -->
  <!-- Pushes -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Push Rate</h3>
        <p><span id="s5"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g1">
        <svg></svg>
      </div>
    </div>
  </div>
    <script>
      bean.on(cronenberg.queries.total_push_rate, 'data-available', function(query) {
          summation = cronenberg.reduce_series(query.data[0]);
          $("#s5").text(summation.mean.toFixed(3));
          makeChart($("#g1"), query.data[0]);
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Delivery -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean End to End<br/>Delivery Time</h3>
        <p><span id="s6"></span><span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g2">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.end_to_end, 'data-available', function(query) {
          summation = cronenberg.reduce_series(query.data[0]);
          $("#s6").text(summation.mean.toFixed(2));
          makeChart($("#g2"), query.data[0]);
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Immediate Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Processed</h3>
        <p><span id="s7"></span><span class="unit">/sec</span></p>
      </div>
    </div>

    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Satisfied</h3>
        <p><span id="s8"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g3">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.immediate_triggers, 'data-available', function(query) {
          summation = cronenberg.reduce_series(query.data[0]);
          $("#s7").text(summation.mean.toFixed(2));
          makeChart($("#g3"), query.data[0]);
          summation = cronenberg.reduce_series(query.data[3]);
          $("#s8").text(summation.mean.toFixed(2));
      });
    </script>


  <!-- ============================================================================= -->
  <!-- Historical Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Processed</h3>
        <p><span id="s9"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Satisfied</h3>
        <p><span id="s10"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g4">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.historical_triggers, 'data-available', function(query) {
          summation = cronenberg.reduce_series(query.data[0]);
          $("#s9").text(summation.mean.toFixed(2));
          makeChart($("#g4"), query.data[0]);
          summation = cronenberg.reduce_series(query.data[3]);
          $("#s10").text(summation.mean.toFixed(2));
      });
    </script>


  <!-- ============================================================================= -->
  <!-- API -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Mean API Response Time</h3>
        <p><span id="s11"></span><span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>API Requests</h3>
        <p id="s12"></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g5">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.api_latency, 'data-available', function(query) {
          summation = cronenberg.reduce_series(query.data[0]);
          $("#s11").text(summation.mean.toFixed(2));
      });
      bean.on(cronenberg.queries.api_rate, 'data-available', function(query) {
          makeChart($("#g5"), query.data[0]);
          summation = cronenberg.reduce_series(query.data[1]);
          $("#s12").text(summation.sum);
      });
    </script>

  <!-- ============================================================================= -->
  <!-- Device Opens -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Device Opens Rate</h3>
        <p><span id="s13"></span><span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph" id="g6">
        <svg></svg>
      </div>
    </div>
  </div>

    <script>
      bean.on(cronenberg.queries.device_event_rate, 'data-available', function(query) {
      summation = cronenberg.reduce_series(query.data[0]);
      $("#s13").text(summation.mean.toFixed(0));
      makeChart($("#g6"), query.data[0]);
      });
    </script>


  <p>&nbsp;</p>

  <script>
    <!-- launch the queries -->
    function makeHandler(query) {
        return function(data) {
            cronenberg.queries[query.name].data = data;
            bean.fire(query, 'data-available', cronenberg.queries[query.name]);
        };
    }
    for (var query_name in cronenberg.queries) {
        var query = cronenberg.queries[query_name]
        console.log(query.url);
        $.getJSON(query.url, makeHandler(query));
    }

    function makeChart(e, series) {
        console.log("makeChart()");
        console.log(series);
        // would rather not transform the whole array here, but I
        // can't get the x/y functions working properly
        var data = [{
            values: series.datapoints,
            key: series.target
        }];
        console.log(data);
        nv.addGraph(function() {
            var width = e.width();
            var height = e.height();
            var chart = nv.models.lineChart()
                .options({
                    showXAxis: false,
                    showYAxis: false,
                    showLegend: false,
                    useInteractiveGuideline: true,
                    x: function(d) { return d[1]; },
                    y: function(d) { return d[0]; }
                })
                .width(width)
                .height(height)
                .margin({ top: 0, right: 0, bottom: 0, left: 0 });
            chart.yAxis.tickFormat(d3.format(',.2f'));
            chart.xAxis.tickFormat(function(d) { return moment.unix(d).fromNow(); });
            d3.select(e.selector + ' svg')
                .attr('width', width)
                .attr('height', height)
                .datum(data)
                .call(chart);
            return chart;
        });
    }

  </script>

{% endblock %}

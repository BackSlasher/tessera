<!-- -*- mode:jinja2 -*- -->
{% extends "layouts/standard.html" %}
{% from "charts/flot.js" import render_chart with context %}

{% block pagetitle %}
<!-- {{config.get('DASHBOARD_APPNAME')}} {{config.get('DASHBOARD_VERSION')}} -->
<span class="primary-title">Automation</span> <span class="secondary-title">Overview</span>
{% endblock %}


{% block layout %}

  <div class="row-fluid text-right">
    {% include "snippets/recent-range-picker.html" %}
  </div>

  <!-- ============================================================================= -->
  <!-- Funnel summary row -->
  <!-- ============================================================================= -->

  <div class="row-fluid">

    <div class="span3">
      <div class="well">
        <div
        <div class="singlestat banner" align="center">
          <h3>Raw Events Processed</h3>
          <p>{{ context['total-events-processed'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Processed</h3>
          <p>{{ context['triggers-processed'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Triggers Satisfied</h3>
          <p>{{ context['triggers-satisfied'] }}</p>
        </div>
      </div>
    </div>

    <div class="span3">
      <div class="well">
        <div class="singlestat banner" align="center">
          <h3>Pushes Sent</h3>
          <p>{{ context['pushes-sent'] }}</p>
        </div>
      </div>
    </div>

  </div> <!-- row -->
  <hr/>

  <!-- ============================================================================= -->
  <!-- Pushes -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Push Rate</h3>
        <p>{{ context['average-push-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['total'][1]['data']  }}"></div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Delivery -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean End to End<br/>Delivery Time</h3>
        <p>{{ context['average-end-to-end']}}<span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['delivery'][0]['data']  }}">
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Immediate Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Processed</h3>
        <p>{{ '{:0.2f}'.format(context['triggers'][0]['avg']) }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Immediate Triggers Satisfied</h3>
        <p>{{ '{:0.2f}'.format(context['triggers'][2]['avg']) }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['triggers'][0]['data']  }}">
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Historical Triggers -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Processed</h3>
        <p>{{ context['historical-processed-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Historical Triggers Satisfied</h3>
        <p>{{ context['historical-satisfied-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['triggers'][4]['data']  }}">
        </div>
      </div>
    </div>
  </div>


  <!-- ============================================================================= -->
  <!-- API -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
      <div class="singlestat">
        <h3>Mean API Response Time</h3>
        <p>{{ context['api-mean-latency'] }}<span class="unit"> ms</span></p>
      </div>
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>API Requests</h3>
        <p>{{ context['api-total'] }}</p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['api-rate'][0]['data']  }}">
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================================= -->
  <!-- Device Opens -->
  <!-- ============================================================================= -->

  <div class="row-fluid graphline">
    <div class="span2">
    </div>
    <div class="span2">
      <div class="singlestat">
        <h3>Mean Device Opens Rate</h3>
        <p>{{ context['mean-device-opens-rate'] }}<span class="unit">/sec</span></p>
      </div>
    </div>
    <div class="span8">
      <div class="graph">
        <div class="graph-container" datastring="{{ context['events'][1]['data']  }}">
        </div>
      </div>
    </div>
  </div>



  <p>&nbsp;</p>

  <script>
    window.charts = {}
    $(".graph-container").map(function(i, e) {
        chartid = "chart" + i;
        overlayid = chartid + "-value";
        console.log(chartid);
        $(e).append('<div class="graph-render" id="' + chartid + '"></div>');
        $(e).append('<div class="value-overlay" id="' + overlayid + '"></div>');
        c = opendash.time_series_chart()
            .container($('#' + chartid))
            .data([{
                data: JSON.parse(e.getAttribute('datastring'))
            }])
            .dataHandler(function(data) {
                $("#" + overlayid + " h3").text(
                    opendash.format_kmbt(data[0].data[data[0].data.length-1][1])
                );
                return data;
            })
            .legend(false)
            .y_label('')
            .stack(false)
            .line_width(1)
            .colors(['#0088cc', '#AA8866'])
            .type('line');
        o = c.options();
        o.grid.show = true;
        o.grid.borderWidth = 0;
        o.xaxis.show = false;
        c();
        window.charts[chartid] = c;
    });

  </script>

{% endblock %}
